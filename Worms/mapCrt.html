<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Map Creator</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />

    <script src="https://cdn.jsdelivr.net/d3js/3.5.9/d3.min.js"></script>
    <link rel="stylesheet" href="css/mapCrt.css" />
    <link rel="icon" href="textury/defBig.png" />

    <style>
      svg {
        border-style: solid;
      }

      ol {
        text-align: left;
      }
    </style>
  </head>

  <body>
    <div class="topnav" class="item1">
      <a href="index.html">Home</a>
      <a href="hra.html">Hra</a>
      <a href="dokumentace.html">Dokumentace</a>
      <a href="ovladani.html">Ovládání</a>
      <a class="active" href="mapCrt.html">Map Creator</a>
    </div>

    <div class="item2">
      <h3>Nakresli si mapu</h3>

      <script>
        var entry;
        let click;
        var listLength = 0;
        var mapArray = "%%";
        var drawingMap = true;

        var mapWorms = "%%";
        var pointsWorms = [];

        var dragging = false,
          drawing = false,
          startPoint;
        var svg = d3
          .select("body")
          .append("svg")
          .attr("height", 705)
          .attr("width", 1520);

        var points = [],
          g;

        if (drawingMap == true) {
          var dragger = d3.behavior.drag().on("dragend", function (d) {
            dragging = false;
          });

          svg.on("mouseup", function () {
            if (dragging == true) {
              points = [];
              console.clear();
              svg.on("click", function () {
                if (click == true) console.log(d3.mouse(this));
                pointsWorms.push(d3.mouse(this));
                console.log(pointsWorms);
                mapWorms += `:${d3.mouse(this)[0]},${d3.mouse(this)[1]}:`;
                g.append("circle")
                  .attr("cx", pointsWorms[i][0])
                  .attr("cy", pointsWorms[i][1])
                  .attr("r", 4)
                  .attr("fill", "yellow")
                  .attr("stroke", "#000")
                  .attr("is-handle", "true");
                click = true;
              });
              g = svg.append("g");
              for (var i = 0; i < pointsWorms.length; i++) {
                g.append("circle")
                  .attr("cx", pointsWorms[i][0])
                  .attr("cy", pointsWorms[i][1])
                  .attr("r", 4)
                  .attr("fill", "yellow")
                  .attr("stroke", "#000")
                  .attr("is-handle", "true");
              }
            } else {
              drawing = true;
              svg.on("mousemove", function () {
                if (!drawing) return;
                var g = d3.select("g.drawPoly");
                g.select("line").remove();
                var line = g
                  .append("line")
                  .attr("x1", startPoint[0])
                  .attr("y1", startPoint[1])
                  .attr("x2", d3.mouse(this)[0] + 2)
                  .attr("y2", d3.mouse(this)[1])
                  .attr("stroke", "#53DBF3")
                  .attr("stroke-width", 1);
              });
              startPoint = [d3.mouse(this)[0], d3.mouse(this)[1]];
              if (svg.select("g.drawPoly").empty())
                g = svg.append("g").attr("class", "drawPoly");

              points.push(d3.mouse(this));
              g.select("polyline").remove();

              var polyline = g
                .append("polyline")
                .attr("points", points)
                .style("fill", "none")
                .attr("stroke", "#000");

              for (var i = 0; i < points.length; i++) {
                g.append("circle")
                  .attr("cx", points[i][0])
                  .attr("cy", points[i][1])
                  .attr("r", 4)
                  .attr("fill", "yellow")
                  .attr("stroke", "#000")
                  .attr("is-handle", "true")
                  .style({ cursor: "pointer" });
              }
            }
          });

          function closePolygon(stayPol) {
            svg.select("g.drawPoly").remove();
            let value = "";
            if (stayPol == true) {
              for (let random = 0; random < points.length; random++) {
                if (random + 1 < points.length) {
                  value +=
                    Math.trunc(points[random][0]) +
                    "," +
                    Math.trunc(points[random][1]) +
                    ",";
                } else {
                  value +=
                    Math.trunc(points[random][0]) +
                    "," +
                    Math.trunc(points[random][1]);
                }
              }
              mapArray += `:${value}:`;
              var g = svg.append("g");
              g.append("polygon")
                .attr("points", points)
                .attr("stay", stayPol)
                .style("fill", "green");

              for (var i = 0; i < points.length; i++) {
                var circle = g
                  .selectAll("circles")
                  .data([points[i]])
                  .enter()
                  .append("circle")
                  .attr("cx", points[i][0])
                  .attr("cy", points[i][1])
                  .attr("r", 4)
                  .attr("fill", "#FDBC07")
                  .attr("stroke", "#000")
                  .attr("is-handle", "true")
                  .style({ cursor: "move" })
                  .call(dragger);
              }
            }

            points.splice(0);
            drawing = false;
          }

          svg.on("mousemove", function () {
            if (!drawing) return;
            var g = d3.select("g.drawPoly");
            g.select("line").remove();
            var line = g
              .append("line")
              .attr("x1", startPoint[0])
              .attr("y1", startPoint[1])
              .attr("x2", d3.mouse(this)[0] + 2)
              .attr("y2", d3.mouse(this)[1])
              .attr("stroke", "#53DBF3")
              .attr("stroke-width", 1);
          });

          function SaveMap() {
            mapArray += "%%";
            mapWorms += "%%";
            mapArray += " " + mapWorms;
            const downloadToFile = (content, filename, contentType) => {
              const a = document.createElement("a");
              const file = new Blob([content], { type: contentType });

              a.href = URL.createObjectURL(file);
              a.download = filename;
              a.click();

              URL.revokeObjectURL(a.href);
            };
            downloadToFile(mapArray, "womsBrowserMap.txt", "text/plain");
          }
        }
        function SwitchMode() {
          var elements = document.getElementsByClassName("drawPoly");
          while (elements.length > 0) {
            elements[0].parentNode.removeChild(elements[0]);
          }
          dragging = true;
          document.getElementById("TextButton").innerHTML =
            "Zadat pozice Wormů";
          document.getElementsByClassName("drawPoly").disabled = true;
          document.getElementsByClassName("drawPoly").className =
            "btn btn-dark";
        }
      </script>
    </div>
    <div class="d-flex flex-row">
      <button class="btn btn-primary p-2 m-1" onclick="closePolygon(true)">
        Zavři Polygon
      </button>
      <button class="btn btn-danger p-2 m-1" onclick="closePolygon(false)">
        Delete
      </button>
      <button class="btn btn-success p-2 m-1" onclick="SaveMap()">Save</button>
      <button id="switchButton" class="m-1" onclick="SwitchMode()">
        <div id="TextButton">Zadat pozice Wormů</div>
      </button>
    </div>
  </body>
</html>
